/*
 *      FM-7 EMULATOR "XM7"
 *
 *      Copyright (C) 1999-2013 ＰＩ．(yasushi@tanaka.net)
 *      Copyright (C) 2001-2013 Ryu Takegami
 *
 *      [ キーボード ]
 */

#include <string.h>
#include "xm7.h"
#include "event.h"
#include "keyboard.h"
#include "mainetc.h"
#include "rtc.h"
#include "device.h"
/*
 * XM7/SDL依存
 */
#ifdef USE_AGAR
#include "agar_xm7.h"
#else
#include "xm7_sdl.h"
#endif

#include "api_draw.h"

/*
 *      グローバル ワーク
 */
BOOL            caps_flag;	/* CAPS フラグ */
BOOL            kana_flag;	/* カナ フラグ */
BOOL            ins_flag;	/* INS フラグ */

BOOL            shift_flag;	/* SHIFTキーフラグ */
BOOL            lshift_flag;	/* 左SHIFTキーフラグ */
BOOL            rshift_flag;	/* 右SHIFTキーフラグ */
BOOL            ctrl_flag;	/* CTRLキーフラグ */
BOOL            graph_flag;	/* GRAPHキーフラグ */
BOOL            break_flag;	/* Breakキーフラグ */

BYTE            key_scan;	/* キーコード(物理コード、Make/Break兼用)
				 */
WORD            key_fm7;	/* キーコード(FM-7互換コード) */
BOOL            key_repeat_flag;	/* キーリピートフラグ */

BYTE            key_format;	/* コードフォーマット */
DWORD           key_repeat_time1;	/* キーリピート開始時間 */
DWORD           key_repeat_time2;	/* キーリピート間隔 */

#if XM7_VER >= 2
BYTE            simpose_mode;	/* スーパーインポーズ モード */
BOOL            simpose_half;	/* スーパーインポーズ
				 * ハーフトーン */

BOOL            digitize_enable;	/* ディジタイズ有効・無効フラグ
					 */
BOOL            digitize_keywait;	/* ディジタイズキー待ち */
#endif

/*
 *      スタティック ワーク
 */
BYTE            key_repeat_code;	/* キーリピートコード */
#if XM7_VER >= 2
BYTE            key_trans_send[16];	/* キーエンコーダ行き送信バッファ
					 */
BYTE            key_trans_sendc;	/* キーエンコーダ行き送信カウンタ
					 */
BYTE            key_trans_recv[16];	/* キーエンコーダから受信バッファ
					 */
BYTE            key_trans_recvc;	/* キーエンコーダから受信カウンタ
					 */
BYTE            key_trans_pos;	/* キーエンコータからのデータ位置
				 */
BOOL            key_trans_rxrdy;	/* キーエンコーダからの受信データあり
					 */
BYTE            simpose_mode_bak;	/* ディジタイズ終了後の画面モード復帰用
					 */
static BOOL     key_trans_ack;	/* キーエンコーダ ACK信号 */
#endif


/*-[ キーテーブル(FM-7互換) ]-----------------------------------------------*/

/*
 *      CTRLモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            ctrl_key_table[] = {
    0x0c, 0x1e, 0x1e,
    0x0d, 0x1c, 0x1c,
    0x11, 0x11, 0x11,
    0x12, 0x17, 0x17,
    0x13, 0x05, 0x05,
    0x14, 0x12, 0x12,
    0x15, 0x14, 0x14,
    0x16, 0x19, 0x19,
    0x17, 0x15, 0x15,
    0x18, 0x09, 0x09,
    0x19, 0x0f, 0x09,
    0x1a, 0x10, 0x10,
    0x1b, 0x00, 0x00,
    0x1c, 0x1b, 0x1b,
    0x1e, 0x01, 0x01,
    0x1f, 0x13, 0x13,
    0x20, 0x04, 0x04,
    0x21, 0x06, 0x06,
    0x22, 0x07, 0x07,
    0x23, 0x08, 0x08,
    0x24, 0x0a, 0x0a,
    0x25, 0x0b, 0x0b,
    0x26, 0x0c, 0x0c,
    0x29, 0x1d, 0x1d,
    0x2a, 0x1a, 0x1a,
    0x2b, 0x18, 0x18,
    0x2c, 0x03, 0x03,
    0x2d, 0x16, 0x16,
    0x2e, 0x02, 0x02,
    0x2f, 0x0e, 0x0e,
    0x30, 0x0d, 0x0d,
    0x34, 0x1f, 0x1f
};

/*
 *      GRAPHモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            graph_key_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0xf9, 0xf9,
    0x03, 0xfa, 0xfa,
    0x04, 0xfb, 0xfb,
    0x05, 0xfc, 0xfc,
    0x06, 0xf2, 0xf2,
    0x07, 0xf3, 0xf3,
    0x08, 0xf4, 0xf4,
    0x09, 0xf5, 0xf5,
    0x0a, 0xf6, 0xf6,
    0x0b, 0xf7, 0xf7,
    0x0c, 0x8c, 0x8c,
    0x0d, 0x8b, 0x8b,
    0x0e, 0xf1, 0xf1,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0xfd, 0xfd,
    0x12, 0xf8, 0xf8,
    0x13, 0xe4, 0xe4,
    0x14, 0xe5, 0xe5,
    0x15, 0x9c, 0x9c,
    0x16, 0x9d, 0x9d,
    0x17, 0xf0, 0xf0,
    0x18, 0xe8, 0xe8,
    0x19, 0xe9, 0xe9,
    0x1a, 0x8d, 0x8d,
    0x1b, 0x8a, 0x8a,
    0x1c, 0xed, 0xed,
    0x1d, 0x0d, 0x0d,

    0x1e, 0x95, 0x95,
    0x1f, 0x96, 0x96,
    0x20, 0xe6, 0xe6,
    0x21, 0xe7, 0xe7,
    0x22, 0x9e, 0x9e,
    0x23, 0x9f, 0x9f,
    0x24, 0xea, 0xea,
    0x25, 0xeb, 0xeb,
    0x26, 0x8e, 0x8e,
    0x27, 0x99, 0x99,
    0x28, 0x94, 0x94,
    0x29, 0xec, 0xec,

    0x2a, 0x80, 0x80,
    0x2b, 0x81, 0x81,
    0x2c, 0x82, 0x82,
    0x2d, 0x83, 0x83,
    0x2e, 0x84, 0x84,
    0x2f, 0x85, 0x85,
    0x30, 0x86, 0x86,
    0x31, 0x87, 0x87,
    0x32, 0x88, 0x88,
    0x33, 0x97, 0x97,
    0x34, 0xe0, 0xe0,

    0x48, 0x12, 0x12,
    0x4d, 0x1e, 0x19,
    0x4b, 0x7f, 0x7f,
    0x4f, 0x1d, 0x02,
    0x50, 0x1f, 0x1a,
    0x51, 0x1c, 0x06,

    0x49, 0x05, 0x05,
    0x4a, 0x0c, 0x0c,
    0x4c, 0x11, 0x11,
    0x4e, 0x0b, 0x0b,

    0x36, 0x98, 0x98,
    0x37, 0x91, 0x91,
    0x38, 0x99, 0x99,
    0x39, 0xee, 0xee,
    0x3a, 0xe1, 0xe1,
    0x3b, 0xe2, 0xe2,
    0x3c, 0xe3, 0xe3,
    0x3d, 0xef, 0xef,
    0x3e, 0x93, 0x93,
    0x3f, 0x8f, 0x8f,
    0x40, 0x92, 0x92,
    0x41, 0xffff, 0xffff,
    0x42, 0x9a, 0x9a,
    0x43, 0x90, 0x90,
    0x44, 0x9b, 0x9b,
    0x45, 0x0d, 0x0d,
    0x46, 0xffff, 0xffff,
    0x47, 0xffff, 0xffff,

    0x57, 0x20, 0x20,
    0x58, 0x20, 0x20,
    0x35, 0x20, 0x20
};

/*
 *      かなモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            kana_key_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0xc7, 0xffff,
    0x03, 0xcc, 0xffff,
    0x04, 0xb1, 0xa7,
    0x05, 0xb3, 0xa9,
    0x06, 0xb4, 0xaa,
    0x07, 0xb5, 0xab,
    0x08, 0xd4, 0xac,
    0x09, 0xd5, 0xad,
    0x0a, 0xd6, 0xae,
    0x0b, 0xdc, 0xa6,
    0x0c, 0xce, 0xffff,
    0x0d, 0xcd, 0xffff,
    0x0e, 0xb0, 0xffff,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0xc0, 0xffff,
    0x12, 0xc3, 0xffff,
    0x13, 0xb2, 0xa8,
    0x14, 0xbd, 0xffff,
    0x15, 0xb6, 0xffff,
    0x16, 0xdd, 0xffff,
    0x17, 0xc5, 0xffff,
    0x18, 0xc6, 0xffff,
    0x19, 0xd7, 0xffff,
    0x1a, 0xbe, 0xffff,
    0x1b, 0xde, 0xffff,
    0x1c, 0xdf, 0xa2,
    0x1d, 0x0d, 0x0d,

    0x1e, 0xc1, 0xffff,
    0x1f, 0xc4, 0xffff,
    0x20, 0xbc, 0xffff,
    0x21, 0xca, 0xffff,
    0x22, 0xb7, 0xffff,
    0x23, 0xb8, 0xffff,
    0x24, 0xcf, 0xffff,
    0x25, 0xc9, 0xffff,
    0x26, 0xd8, 0xffff,
    0x27, 0xda, 0xffff,
    0x28, 0xb9, 0xffff,
    0x29, 0xd1, 0xa3,

    0x2a, 0xc2, 0xaf,
    0x2b, 0xbb, 0xffff,
    0x2c, 0xbf, 0xffff,
    0x2d, 0xcb, 0xffff,
    0x2e, 0xba, 0xffff,
    0x2f, 0xd0, 0xffff,
    0x30, 0xd3, 0xffff,
    0x31, 0xc8, 0xa4,
    0x32, 0xd9, 0xa1,
    0x33, 0xd2, 0xa5,
    0x34, 0xdb, 0xffff,

    0x48, 0x12, 0x12,
    0x4d, 0x1e, 0x19,
    0x4b, 0x7f, 0x7f,
    0x4f, 0x1d, 0x02,
    0x50, 0x1f, 0x1a,
    0x51, 0x1c, 0x06,

    0x49, 0x05, 0x05,
    0x4a, 0x0c, 0x0c,
    0x4c, 0x11, 0x11,
    0x4e, 0x0b, 0x0b,

    0x36, 0x2a, 0x2a,
    0x37, 0x2f, 0x2f,
    0x38, 0x2b, 0x2b,
    0x39, 0x2d, 0x2d,
    0x3a, 0x37, 0x37,
    0x3b, 0x38, 0x38,
    0x3c, 0x39, 0x39,
    0x3d, 0x3d, 0x3d,
    0x3e, 0x34, 0x34,
    0x3f, 0x35, 0x35,
    0x40, 0x36, 0x36,
    0x41, 0x2c, 0x2c,
    0x42, 0x31, 0x31,
    0x43, 0x32, 0x32,
    0x44, 0x33, 0x33,
    0x45, 0x0d, 0x0d,
    0x46, 0x30, 0x30,
    0x47, 0x2e, 0x2e,

    0x57, 0x20, 0x20,
    0x58, 0x20, 0x20,
    0x35, 0x20, 0x20
};

/*
 *      CAPモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            caps_key_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0x31, 0x21,
    0x03, 0x32, 0x22,
    0x04, 0x33, 0x23,
    0x05, 0x34, 0x24,
    0x06, 0x35, 0x25,
    0x07, 0x36, 0x26,
    0x08, 0x37, 0x27,
    0x09, 0x38, 0x28,
    0x0a, 0x39, 0x29,
    0x0b, 0x30, 0xffff,
    0x0c, 0x2d, 0x3d,
    0x0d, 0x5e, 0x7e,
    0x0e, 0x5c, 0x7c,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0x51, 0x71,
    0x12, 0x57, 0x77,
    0x13, 0x45, 0x65,
    0x14, 0x52, 0x72,
    0x15, 0x54, 0x74,
    0x16, 0x59, 0x79,
    0x17, 0x55, 0x75,
    0x18, 0x49, 0x69,
    0x19, 0x4f, 0x6f,
    0x1a, 0x50, 0x70,
    0x1b, 0x40, 0x60,
    0x1c, 0x5b, 0x7b,
    0x1d, 0x0d, 0x0d,

    0x1e, 0x41, 0x61,
    0x1f, 0x53, 0x73,
    0x20, 0x44, 0x64,
    0x21, 0x46, 0x66,
    0x22, 0x47, 0x67,
    0x23, 0x48, 0x68,
    0x24, 0x4a, 0x6a,
    0x25, 0x4b, 0x6b,
    0x26, 0x4c, 0x6c,
    0x27, 0x3b, 0x2b,
    0x28, 0x3a, 0x2a,
    0x29, 0x5d, 0x7d,

    0x2a, 0x5a, 0x7a,
    0x2b, 0x58, 0x78,
    0x2c, 0x43, 0x63,
    0x2d, 0x56, 0x76,
    0x2e, 0x42, 0x62,
    0x2f, 0x4e, 0x6e,
    0x30, 0x4d, 0x6d,
    0x31, 0x2c, 0x3c,
    0x32, 0x2e, 0x3e,
    0x33, 0x2f, 0x3f,
    0x34, 0x22, 0x5f,

    0x48, 0x12, 0x12,
    0x4d, 0x1e, 0x19,
    0x4b, 0x7f, 0x7f,
    0x4f, 0x1d, 0x02,
    0x50, 0x1f, 0x1a,
    0x51, 0x1c, 0x06,

    0x49, 0x05, 0x05,
    0x4a, 0x0c, 0x0c,
    0x4c, 0x11, 0x11,
    0x4e, 0x0b, 0x0b,

    0x36, 0x2a, 0x2a,
    0x37, 0x2f, 0x2f,
    0x38, 0x2b, 0x2b,
    0x39, 0x2d, 0x2d,
    0x3a, 0x37, 0x37,
    0x3b, 0x38, 0x38,
    0x3c, 0x39, 0x39,
    0x3d, 0x3d, 0x3d,
    0x3e, 0x34, 0x34,
    0x3f, 0x35, 0x35,
    0x40, 0x36, 0x36,
    0x41, 0x2c, 0x2c,
    0x42, 0x31, 0x31,
    0x43, 0x32, 0x32,
    0x44, 0x33, 0x33,
    0x45, 0x0d, 0x0d,
    0x46, 0x30, 0x30,
    0x47, 0x2e, 0x2e,

    0x57, 0x20, 0x20,
    0x58, 0x20, 0x20,
    0x35, 0x20, 0x20
};

/*
 *      NORMALモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            norm_key_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0x31, 0x21,
    0x03, 0x32, 0x22,
    0x04, 0x33, 0x23,
    0x05, 0x34, 0x24,
    0x06, 0x35, 0x25,
    0x07, 0x36, 0x26,
    0x08, 0x37, 0x27,
    0x09, 0x38, 0x28,
    0x0a, 0x39, 0x29,
    0x0b, 0x30, 0xffff,
    0x0c, 0x2d, 0x3d,
    0x0d, 0x5e, 0x7e,
    0x0e, 0x5c, 0x7c,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0x71, 0x51,
    0x12, 0x77, 0x57,
    0x13, 0x65, 0x45,
    0x14, 0x72, 0x52,
    0x15, 0x74, 0x54,
    0x16, 0x79, 0x59,
    0x17, 0x75, 0x55,
    0x18, 0x69, 0x49,
    0x19, 0x6f, 0x4f,
    0x1a, 0x70, 0x50,
    0x1b, 0x40, 0x60,
    0x1c, 0x5b, 0x7b,
    0x1d, 0x0d, 0x0d,

    0x1e, 0x61, 0x41,
    0x1f, 0x73, 0x53,
    0x20, 0x64, 0x44,
    0x21, 0x66, 0x46,
    0x22, 0x67, 0x47,
    0x23, 0x68, 0x48,
    0x24, 0x6a, 0x4a,
    0x25, 0x6b, 0x4b,
    0x26, 0x6c, 0x4c,
    0x27, 0x3b, 0x2b,
    0x28, 0x3a, 0x2a,
    0x29, 0x5d, 0x7d,

    0x2a, 0x7a, 0x5a,
    0x2b, 0x78, 0x58,
    0x2c, 0x63, 0x43,
    0x2d, 0x76, 0x56,
    0x2e, 0x62, 0x42,
    0x2f, 0x6e, 0x4e,
    0x30, 0x6d, 0x4d,
    0x31, 0x2c, 0x3c,
    0x32, 0x2e, 0x3e,
    0x33, 0x2f, 0x3f,
    0x34, 0x22, 0x5f,

    0x48, 0x12, 0x12,
    0x4d, 0x1e, 0x19,
    0x4b, 0x7f, 0x7f,
    0x4f, 0x1d, 0x02,
    0x50, 0x1f, 0x1a,
    0x51, 0x1c, 0x06,

    0x49, 0x05, 0x05,
    0x4a, 0x0c, 0x0c,
    0x4c, 0x11, 0x11,
    0x4e, 0x0b, 0x0b,

    0x36, 0x2a, 0x2a,
    0x37, 0x2f, 0x2f,
    0x38, 0x2b, 0x2b,
    0x39, 0x2d, 0x2d,
    0x3a, 0x37, 0x37,
    0x3b, 0x38, 0x38,
    0x3c, 0x39, 0x39,
    0x3d, 0x3d, 0x3d,
    0x3e, 0x34, 0x34,
    0x3f, 0x35, 0x35,
    0x40, 0x36, 0x36,
    0x41, 0x2c, 0x2c,
    0x42, 0x31, 0x31,
    0x43, 0x32, 0x32,
    0x44, 0x33, 0x33,
    0x45, 0x0d, 0x0d,
    0x46, 0x30, 0x30,
    0x47, 0x2e, 0x2e,

    0x57, 0x20, 0x20,
    0x58, 0x20, 0x20,
    0x35, 0x20, 0x20
};

/*-[ キーテーブル(FM-16β互換) ]--------------------------------------------*/

#if XM7_VER >= 2
/*
 *      CTRLモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            ctrl_16b_table[] = {
    0x0c, 0x1e, 0x1e,
    0x0d, 0x1c, 0x1c,
    0x11, 0x11, 0x11,
    0x12, 0x17, 0x17,
    0x13, 0x05, 0x05,
    0x14, 0x12, 0x12,
    0x15, 0x14, 0x14,
    0x16, 0x19, 0x19,
    0x17, 0x15, 0x15,
    0x18, 0x09, 0x09,
    0x19, 0x0f, 0x09,
    0x1a, 0x10, 0x10,
    0x1b, 0x00, 0x00,
    0x1c, 0x1b, 0x1b,
    0x1e, 0x01, 0x01,
    0x1f, 0x13, 0x13,
    0x20, 0x04, 0x04,
    0x21, 0x06, 0x06,
    0x22, 0x07, 0x07,
    0x23, 0x08, 0x08,
    0x24, 0x0a, 0x0a,
    0x25, 0x0b, 0x0b,
    0x26, 0x0c, 0x0c,
    0x29, 0x1d, 0x1d,
    0x2a, 0x1a, 0x1a,
    0x2b, 0x18, 0x18,
    0x2c, 0x03, 0x03,
    0x2d, 0x16, 0x16,
    0x2e, 0x02, 0x02,
    0x2f, 0x0e, 0x0e,
    0x30, 0x0d, 0x0d,
    0x34, 0x1f, 0x1f,

    0x57, 0x14e, 0x14e,
    0x58, 0x14d, 0x14d,

    0x49, 0x152, 0x152,
    0x4a, 0x151, 0x151,
    0x4c, 0x153, 0x153,
    0x4e, 0x155, 0x155,

    0x48, 0x150, 0x150,
    0x4d, 0x156, 0x156,
    0x4b, 0x154, 0x154,
    0x4f, 0x158, 0x158,
    0x50, 0x157, 0x157,
    0x51, 0x159, 0x159
};

/*
 *      GRAPHモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            graph_16b_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0xf9, 0xf9,
    0x03, 0xfa, 0xfa,
    0x04, 0xfb, 0xfb,
    0x05, 0xfc, 0xfc,
    0x06, 0xf2, 0xf2,
    0x07, 0xf3, 0xf3,
    0x08, 0xf4, 0xf4,
    0x09, 0xf5, 0xf5,
    0x0a, 0xf6, 0xf6,
    0x0b, 0xf7, 0xf7,
    0x0c, 0x8c, 0x8c,
    0x0d, 0x8b, 0x8b,
    0x0e, 0xf1, 0xf1,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0xfd, 0xfd,
    0x12, 0xf8, 0xf8,
    0x13, 0xe4, 0xe4,
    0x14, 0xe5, 0xe5,
    0x15, 0x9c, 0x9c,
    0x16, 0x9d, 0x9d,
    0x17, 0xf0, 0xf0,
    0x18, 0xe8, 0xe8,
    0x19, 0xe9, 0xe9,
    0x1a, 0x8d, 0x8d,
    0x1b, 0x8a, 0x8a,
    0x1c, 0xed, 0xed,
    0x1d, 0x0d, 0x0d,

    0x1e, 0x95, 0x95,
    0x1f, 0x96, 0x96,
    0x20, 0xe6, 0xe6,
    0x21, 0xe7, 0xe7,
    0x22, 0x9e, 0x9e,
    0x23, 0x9f, 0x9f,
    0x24, 0xea, 0xea,
    0x25, 0xeb, 0xeb,
    0x26, 0x8e, 0x8e,
    0x27, 0x99, 0x99,
    0x28, 0x94, 0x94,
    0x29, 0xec, 0xec,

    0x2a, 0x80, 0x80,
    0x2b, 0x81, 0x81,
    0x2c, 0x82, 0x82,
    0x2d, 0x83, 0x83,
    0x2e, 0x84, 0x84,
    0x2f, 0x85, 0x85,
    0x30, 0x86, 0x86,
    0x31, 0x87, 0x87,
    0x32, 0x88, 0x88,
    0x33, 0x97, 0x97,
    0x34, 0xe0, 0xe0,

    0x48, 0x110, 0x130,
    0x4d, 0x116, 0x136,
    0x4b, 0x114, 0x134,
    0x4f, 0x118, 0x138,
    0x50, 0x117, 0x137,
    0x51, 0x119, 0x139,

    0x49, 0x112, 0x132,
    0x4a, 0x111, 0x131,
    0x4c, 0x113, 0x133,
    0x4e, 0x115, 0x135,

    0x36, 0x98, 0x98,
    0x37, 0x91, 0x91,
    0x38, 0x99, 0x99,
    0x39, 0xee, 0xee,
    0x3a, 0xe1, 0xe1,
    0x3b, 0xe2, 0xe2,
    0x3c, 0xe3, 0xe3,
    0x3d, 0xef, 0xef,
    0x3e, 0x93, 0x93,
    0x3f, 0x8f, 0x8f,
    0x40, 0x92, 0x92,
    0x41, 0xffff, 0xffff,
    0x42, 0x9a, 0x9a,
    0x43, 0x90, 0x90,
    0x44, 0x9b, 0x9b,
    0x45, 0x0d, 0x0d,
    0x46, 0xffff, 0xffff,
    0x47, 0xffff, 0xffff,

    0x57, 0x10e, 0x12e,
    0x58, 0x10d, 0x12d,
    0x35, 0x20, 0x20
};

/*
 *      かなモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            kana_16b_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0xc7, 0xffff,
    0x03, 0xcc, 0xffff,
    0x04, 0xb1, 0xa7,
    0x05, 0xb3, 0xa9,
    0x06, 0xb4, 0xaa,
    0x07, 0xb5, 0xab,
    0x08, 0xd4, 0xac,
    0x09, 0xd5, 0xad,
    0x0a, 0xd6, 0xae,
    0x0b, 0xdc, 0xa6,
    0x0c, 0xce, 0xffff,
    0x0d, 0xcd, 0xffff,
    0x0e, 0xb0, 0xffff,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0xc0, 0xffff,
    0x12, 0xc3, 0xffff,
    0x13, 0xb2, 0xa8,
    0x14, 0xbd, 0xffff,
    0x15, 0xb6, 0xffff,
    0x16, 0xdd, 0xffff,
    0x17, 0xc5, 0xffff,
    0x18, 0xc6, 0xffff,
    0x19, 0xd7, 0xffff,
    0x1a, 0xbe, 0xffff,
    0x1b, 0xde, 0xffff,
    0x1c, 0xdf, 0xa2,
    0x1d, 0x0d, 0x0d,

    0x1e, 0xc1, 0xffff,
    0x1f, 0xc4, 0xffff,
    0x20, 0xbc, 0xffff,
    0x21, 0xca, 0xffff,
    0x22, 0xb7, 0xffff,
    0x23, 0xb8, 0xffff,
    0x24, 0xcf, 0xffff,
    0x25, 0xc9, 0xffff,
    0x26, 0xd8, 0xffff,
    0x27, 0xda, 0xffff,
    0x28, 0xb9, 0xffff,
    0x29, 0xd1, 0xa3,

    0x2a, 0xc2, 0xaf,
    0x2b, 0xbb, 0xffff,
    0x2c, 0xbf, 0xffff,
    0x2d, 0xcb, 0xffff,
    0x2e, 0xba, 0xffff,
    0x2f, 0xd0, 0xffff,
    0x30, 0xd3, 0xffff,
    0x31, 0xc8, 0xa4,
    0x32, 0xd9, 0xa1,
    0x33, 0xd2, 0xa5,
    0x34, 0xdb, 0xffff,

    0x48, 0x110, 0x130,
    0x4d, 0x116, 0x136,
    0x4b, 0x114, 0x134,
    0x4f, 0x118, 0x138,
    0x50, 0x117, 0x137,
    0x51, 0x119, 0x139,

    0x49, 0x112, 0x132,
    0x4a, 0x111, 0x131,
    0x4c, 0x113, 0x133,
    0x4e, 0x115, 0x135,

    0x36, 0x2a, 0x2a,
    0x37, 0x2f, 0x2f,
    0x38, 0x2b, 0x2b,
    0x39, 0x2d, 0x2d,
    0x3a, 0x37, 0x37,
    0x3b, 0x38, 0x38,
    0x3c, 0x39, 0x39,
    0x3d, 0x3d, 0x3d,
    0x3e, 0x34, 0x34,
    0x3f, 0x35, 0x35,
    0x40, 0x36, 0x36,
    0x41, 0x2c, 0x2c,
    0x42, 0x31, 0x31,
    0x43, 0x32, 0x32,
    0x44, 0x33, 0x33,
    0x45, 0x0d, 0x0d,
    0x46, 0x30, 0x30,
    0x47, 0x2e, 0x2e,

    0x57, 0x10e, 0x12e,
    0x58, 0x10d, 0x12d,
    0x35, 0x20, 0x20
};

/*
 *      CAPモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            caps_16b_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0x31, 0x21,
    0x03, 0x32, 0x22,
    0x04, 0x33, 0x23,
    0x05, 0x34, 0x24,
    0x06, 0x35, 0x25,
    0x07, 0x36, 0x26,
    0x08, 0x37, 0x27,
    0x09, 0x38, 0x28,
    0x0a, 0x39, 0x29,
    0x0b, 0x30, 0xffff,
    0x0c, 0x2d, 0x3d,
    0x0d, 0x5e, 0x7e,
    0x0e, 0x5c, 0x7c,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0x51, 0x71,
    0x12, 0x57, 0x77,
    0x13, 0x45, 0x65,
    0x14, 0x52, 0x72,
    0x15, 0x54, 0x74,
    0x16, 0x59, 0x79,
    0x17, 0x55, 0x75,
    0x18, 0x49, 0x69,
    0x19, 0x4f, 0x6f,
    0x1a, 0x50, 0x70,
    0x1b, 0x40, 0x60,
    0x1c, 0x5b, 0x7b,
    0x1d, 0x0d, 0x0d,

    0x1e, 0x41, 0x61,
    0x1f, 0x53, 0x73,
    0x20, 0x44, 0x64,
    0x21, 0x46, 0x66,
    0x22, 0x47, 0x67,
    0x23, 0x48, 0x68,
    0x24, 0x4a, 0x6a,
    0x25, 0x4b, 0x6b,
    0x26, 0x4c, 0x6c,
    0x27, 0x3b, 0x2b,
    0x28, 0x3a, 0x2a,
    0x29, 0x5d, 0x7d,

    0x2a, 0x5a, 0x7a,
    0x2b, 0x58, 0x78,
    0x2c, 0x43, 0x63,
    0x2d, 0x56, 0x76,
    0x2e, 0x42, 0x62,
    0x2f, 0x4e, 0x6e,
    0x30, 0x4d, 0x6d,
    0x31, 0x2c, 0x3c,
    0x32, 0x2e, 0x3e,
    0x33, 0x2f, 0x3f,
    0x34, 0x22, 0x5f,

    0x48, 0x110, 0x130,
    0x4d, 0x116, 0x136,
    0x4b, 0x114, 0x134,
    0x4f, 0x118, 0x138,
    0x50, 0x117, 0x137,
    0x51, 0x119, 0x139,

    0x49, 0x112, 0x132,
    0x4a, 0x111, 0x131,
    0x4c, 0x113, 0x133,
    0x4e, 0x115, 0x135,

    0x36, 0x2a, 0x2a,
    0x37, 0x2f, 0x2f,
    0x38, 0x2b, 0x2b,
    0x39, 0x2d, 0x2d,
    0x3a, 0x37, 0x37,
    0x3b, 0x38, 0x38,
    0x3c, 0x39, 0x39,
    0x3d, 0x3d, 0x3d,
    0x3e, 0x34, 0x34,
    0x3f, 0x35, 0x35,
    0x40, 0x36, 0x36,
    0x41, 0x2c, 0x2c,
    0x42, 0x31, 0x31,
    0x43, 0x32, 0x32,
    0x44, 0x33, 0x33,
    0x45, 0x0d, 0x0d,
    0x46, 0x30, 0x30,
    0x47, 0x2e, 0x2e,

    0x57, 0x10e, 0x12e,
    0x58, 0x10d, 0x12d,
    0x35, 0x20, 0x20
};

/*
 *      NORMALモード
 *      物理コード、SHIFTなし、SHIFTありの順
 */
WORD            norm_16b_table[] = {
    0x5d, 0x0101, 0xffff,
    0x5e, 0x0102, 0xffff,
    0x5f, 0x0103, 0xffff,
    0x60, 0x0104, 0xffff,
    0x61, 0x0105, 0xffff,
    0x62, 0x0106, 0xffff,
    0x63, 0x0107, 0xffff,
    0x64, 0x0108, 0xffff,
    0x65, 0x0109, 0xffff,
    0x66, 0x010a, 0xffff,

    0x01, 0x1b, 0x1b,
    0x02, 0x31, 0x21,
    0x03, 0x32, 0x22,
    0x04, 0x33, 0x23,
    0x05, 0x34, 0x24,
    0x06, 0x35, 0x25,
    0x07, 0x36, 0x26,
    0x08, 0x37, 0x27,
    0x09, 0x38, 0x28,
    0x0a, 0x39, 0x29,
    0x0b, 0x30, 0xffff,
    0x0c, 0x2d, 0x3d,
    0x0d, 0x5e, 0x7e,
    0x0e, 0x5c, 0x7c,
    0x0f, 0x08, 0x08,

    0x10, 0x09, 0x09,
    0x11, 0x71, 0x51,
    0x12, 0x77, 0x57,
    0x13, 0x65, 0x45,
    0x14, 0x72, 0x52,
    0x15, 0x74, 0x54,
    0x16, 0x79, 0x59,
    0x17, 0x75, 0x55,
    0x18, 0x69, 0x49,
    0x19, 0x6f, 0x4f,
    0x1a, 0x70, 0x50,
    0x1b, 0x40, 0x60,
    0x1c, 0x5b, 0x7b,
    0x1d, 0x0d, 0x0d,

    0x1e, 0x61, 0x41,
    0x1f, 0x73, 0x53,
    0x20, 0x64, 0x44,
    0x21, 0x66, 0x46,
    0x22, 0x67, 0x47,
    0x23, 0x68, 0x48,
    0x24, 0x6a, 0x4a,
    0x25, 0x6b, 0x4b,
    0x26, 0x6c, 0x4c,
    0x27, 0x3b, 0x2b,
    0x28, 0x3a, 0x2a,
    0x29, 0x5d, 0x7d,

    0x2a, 0x7a, 0x5a,
    0x2b, 0x78, 0x58,
    0x2c, 0x63, 0x43,
    0x2d, 0x76, 0x56,
    0x2e, 0x62, 0x42,
    0x2f, 0x6e, 0x4e,
    0x30, 0x6d, 0x4d,
    0x31, 0x2c, 0x3c,
    0x32, 0x2e, 0x3e,
    0x33, 0x2f, 0x3f,
    0x34, 0x22, 0x5f,

    0x48, 0x110, 0x130,
    0x4d, 0x116, 0x136,
    0x4b, 0x114, 0x134,
    0x4f, 0x118, 0x138,
    0x50, 0x117, 0x137,
    0x51, 0x119, 0x139,

    0x49, 0x112, 0x132,
    0x4a, 0x111, 0x131,
    0x4c, 0x113, 0x133,
    0x4e, 0x115, 0x135,

    0x36, 0x2a, 0x2a,
    0x37, 0x2f, 0x2f,
    0x38, 0x2b, 0x2b,
    0x39, 0x2d, 0x2d,
    0x3a, 0x37, 0x37,
    0x3b, 0x38, 0x38,
    0x3c, 0x39, 0x39,
    0x3d, 0x3d, 0x3d,
    0x3e, 0x34, 0x34,
    0x3f, 0x35, 0x35,
    0x40, 0x36, 0x36,
    0x41, 0x2c, 0x2c,
    0x42, 0x31, 0x31,
    0x43, 0x32, 0x32,
    0x44, 0x33, 0x33,
    0x45, 0x0d, 0x0d,
    0x46, 0x30, 0x30,
    0x47, 0x2e, 0x2e,

    0x57, 0x10e, 0x12e,
    0x58, 0x10d, 0x12d,
    0x35, 0x20, 0x20
};
#endif


/*-[ キーボード ]-----------------------------------------------------------*/

/*
 *      キーボード
 *      初期化
 */
BOOL            FASTCALL
keyboard_init(void)
{
#if XM7_VER >= 2
    /*
     * ディジタイズカード装着
     */
    digitize_enable = TRUE;
#endif

    return TRUE;
}

/*
 *      キーボード
 *      クリーンアップ
 */
void            FASTCALL
keyboard_cleanup(void)
{
}

/*
 *      キーボード
 *      リセット
 */
void            FASTCALL
keyboard_reset(void)
{
    /*
     * キー別のフラグ
     */
    caps_flag = FALSE;
    kana_flag = FALSE;
    ins_flag = FALSE;

    shift_flag = FALSE;
    lshift_flag = FALSE;
    rshift_flag = FALSE;
    ctrl_flag = FALSE;
    graph_flag = FALSE;
    break_flag = FALSE;

    /*
     * リセット時はkey_fm7 != 0にする(デスフォース対策)
     */
    key_scan = 0;
    key_fm7 = 0xffff;

    /*
     * キーボードパラメータ
     */
    key_format = KEY_FORMAT_9BIT;
    key_repeat_time1 = 700000;
    key_repeat_time2 = 70000;

    key_repeat_flag = TRUE;
    key_repeat_code = 0;

#if XM7_VER >= 2
    /*
     * キーボードエンコーダ
     */
    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
    key_trans_ack = TRUE;

    /*
     * スーパーインポーズ
     */
    simpose_mode = 0;
    simpose_half = FALSE;

    /*
     * ディジタイズ
     */
    digitize_keywait = FALSE;
    simpose_mode_bak = 0;
#endif
}

/*-[ キーエンコーダ(FM77AV) ]-----------------------------------------------*/

#if XM7_VER >= 2
/*
 *      コード系設定
 */
static void     FASTCALL
key_set_format(void)
{
    /*
     * パラメータチェック
     */
    if (key_trans_send[1] <= KEY_FORMAT_SCAN) {
	/*
	 * 設定
	 */
	key_format = key_trans_send[1];
	caps_flag = FALSE;
	kana_flag = FALSE;
	ins_flag = FALSE;
	key_repeat_flag = TRUE;
	key_repeat_code = 0;
	key_repeat_time1 = 700000;
	key_repeat_time2 = 70000;

	/*
	 * シフト解除 (F-BASIC V3.3/V3.4 日本語モード)
	 */
	shift_flag = FALSE;
	lshift_flag = FALSE;
	rshift_flag = FALSE;
	ctrl_flag = FALSE;
	graph_flag = FALSE;
    }

    /*
     * 終了
     */
    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      コード系取得
 */
static void     FASTCALL
key_get_format(void)
{
    /*
     * レスポンス設定
     */
    key_trans_recv[0] = key_format;

    key_trans_sendc = 0;
    key_trans_recvc = 1;
    key_trans_pos = 0;
    key_trans_rxrdy = TRUE;
}

/*
 *      LED設定
 */
static void     FASTCALL
key_set_led(void)
{
    switch (key_trans_send[1]) {
	/*
	 * CAP ON
	 */
    case 0:
	caps_flag = TRUE;
	break;

	/*
	 * CAP OFF
	 */
    case 1:
	caps_flag = FALSE;
	break;

	/*
	 * かな ON
	 */
    case 2:
	kana_flag = TRUE;
	break;

	/*
	 * かな OFF
	 */
    case 3:
	kana_flag = FALSE;
	break;
    }

    /*
     * 終了
     */
    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      LED取得
 */
static void     FASTCALL
key_get_led(void)
{
    /*
     * レスポンス設定
     */
    key_trans_recv[0] = 0;
    if (caps_flag) {
	key_trans_recv[0] |= 0x01;
    }
    if (kana_flag) {
	key_trans_recv[0] |= 0x02;
    }

    key_trans_sendc = 0;
    key_trans_recvc = 1;
    key_trans_pos = 0;
    key_trans_rxrdy = TRUE;
}

/*
 *      キーリピート設定
 */
static void     FASTCALL
key_set_repeat(void)
{
    switch (key_trans_send[1]) {
	/*
	 * リピートON
	 */
    case 0:
	key_repeat_flag = TRUE;
	key_repeat_code = 0;
	break;

	/*
	 * リピートOFF
	 */
    case 1:
	key_repeat_flag = FALSE;
	break;
    }

    /*
     * 終了
     */
    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      キーリピート時間設定
 */
static void     FASTCALL
key_set_time(void)
{
    if ((key_trans_send[1] == 0) || (key_trans_send[2] == 0)) {
	/*
	 * どちらかが0なら、デフォルトに設定
	 */
	key_repeat_time1 = 700000;
	key_repeat_time2 = 70000;
    } else {
	/*
	 * パラメータ×10msに設定
	 */
	key_repeat_time1 = (DWORD) key_trans_send[1];
	key_repeat_time1 *= 10000;
	key_repeat_time2 = (DWORD) key_trans_send[2];
	key_repeat_time2 *= 10000;
    }

    /*
     * 終了
     */
    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      RTC設定
 */
static void     FASTCALL
key_set_rtc(void)
{
    /*
     * 時計セット
     */
    rtc_set(&key_trans_send[2]);

    /*
     * 終了
     */
    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      RTC取得
 */
static void     FASTCALL
key_get_rtc(void)
{
    /*
     * 時計取得
     */
    rtc_get(&key_trans_recv[0]);

    key_trans_sendc = 0;
    key_trans_recvc = 7;
    key_trans_pos = 0;
    key_trans_rxrdy = TRUE;
}

/*
 *      画面ディジタイズ
 */
static void     FASTCALL
key_capture(void)
{
    /*
     * ディジタイズon
     */
    digitize_keywait = TRUE;
    simpose_mode_bak = simpose_mode;
    simpose_mode = 3;

    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      画面モード設定
 */
static void     FASTCALL
key_set_scrmode(void)
{
    /*
     * パラメータを受け取る
     */
    switch (key_trans_send[1]) {
	/*
	 * パソコンモード
	 */
    case 0x00:
	simpose_mode = 0;
	break;
	/*
	 * スーパーインポーズモード
	 */
    case 0x01:
	simpose_mode = 1;
	break;
	/*
	 * テレビモード
	 */
    case 0x02:
	simpose_mode = 2;
	break;
	/*
	 * ディジタイズモード
	 */
    case 0x03:
	simpose_mode = 3;
	break;
	/*
	 * それ以外は、未定義パラメータとしてスキップ
	 */
    default:
	break;
    }

    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      画面モード取得
 */
static void     FASTCALL
key_get_scrmode(void)
{
    /*
     * レスポンス設定
     */
    if (simpose_half) {
	key_trans_recv[0] = 0x01;
    } else {
	key_trans_recv[0] = 0x00;
    }

    key_trans_sendc = 0;
    key_trans_recvc = 1;
    key_trans_pos = 0;
    key_trans_rxrdy = TRUE;
}

/*
 *      画面輝度設定
 */
static void     FASTCALL
key_set_scrtone(void)
{
    /*
     * パラメータを受け取る
     */
    switch (key_trans_send[1]) {
	/*
	 * 画面高輝度モード
	 */
    case 0x00:
	simpose_half = FALSE;
	break;
	/*
	 * ハーフトーンモード
	 */
    case 0x01:
	simpose_half = TRUE;
	break;
	/*
	 * それ以外は、未定義パラメータとしてスキップ
	 */
    default:
	break;
    }

    key_trans_sendc = 0;
    key_trans_recvc = 0;
    key_trans_pos = 0;
    key_trans_rxrdy = FALSE;
}

/*
 *      キーボード
 *      ACK信号送信
 */
static BOOL     FASTCALL
key_send_ack(void)
{
    key_trans_ack = TRUE;
    schedule_delevent(EVENT_KEYENC_ACK);
    return TRUE;
}
#endif

/*-[ メモリマップドI/O ]----------------------------------------------------*/

/*
 *      キーボード
 *      １バイト読み込み
 */
BOOL            FASTCALL
keyboard_readb(WORD addr, BYTE * dat)
{
#if XM7_VER >= 2
    BYTE            tmp;
#endif
   
    switch (addr) {
	/*
	 * キーコード上位
	 */
    case 0xd400:
	if (key_fm7 & 0x0100) {
	    *dat = 0xff;
	} else {
	    *dat = 0x7f;
	}
	return TRUE;

	/*
	 * キーコード下位
	 */
    case 0xd401:
	*dat = (BYTE) (key_fm7 & 0xff);
	/*
	 * 割り込みoff
	 */
	key_irq_flag = FALSE;
	maincpu_irq();
	subcpu_firq();
	return TRUE;

	/*
	 * INS LED ON
	 */
    case 0xd40d:
	ins_flag = TRUE;
	return TRUE;

#if XM7_VER >= 2
	/*
	 * キーエンコーダ データ受信
	 */
    case 0xd431:
	if (fm7_ver >= 2) {
	    *dat = key_trans_recv[key_trans_pos];
	    /*
	     * バッファ内実データの範囲内で、進める
	     */
	    if (key_trans_pos < key_trans_recvc) {
		key_trans_pos++;
		key_trans_rxrdy = FALSE;
	    }
	} else {
	    *dat = 0xff;
	}
	return TRUE;

	/*
	 * キーエンコーダ ステータス
	 */
    case 0xd432:
	if (fm7_ver >= 2) {
	    if (key_trans_rxrdy) {
		tmp = 0x7f;
	    } else {
		tmp = 0xff;
	    }
	    /*
	     * ディジタイズキー待ちの場合はACK
	     * SENDを送信しない
	     */
	    if (!key_trans_ack || digitize_keywait) {
		tmp &= 0xfe;
	    }
	    *dat = tmp;

	    /*
	     * データがあれば、RXRDY
	     */
	    if (key_trans_pos < key_trans_recvc) {
		key_trans_rxrdy = TRUE;
	    }
	} else {
	    *dat = 0xff;
	}
	return TRUE;
#endif
    }

    return FALSE;
}

/*
 *      キーボード
 *      １バイト書き込み
 */
BOOL            FASTCALL
keyboard_writeb(WORD addr, BYTE dat)
{
#if XM7_VER == 1
     UNUSED(dat);
#endif

     switch (addr) {
	/*
	 * キーコード上位
	 */
    case 0xd400:
	return TRUE;

	/*
	 * キーコード下位
	 */
    case 0xd401:
	return TRUE;

	/*
	 * INS LED OFF
	 */
    case 0xd40d:
	ins_flag = FALSE;
	return TRUE;

#if XM7_VER >= 2
	/*
	 * キーエンコーダ データ送信
	 */
    case 0xd431:
	if (fm7_ver >= 2) {
	    /*
	     * バッファ越えのチェック
	     */
	    if (key_trans_sendc >= 16) {
		key_trans_sendc = 0;
		break;
	    }
	    /*
	     * データセット、終了チェック
	     */
	    key_trans_send[key_trans_sendc++] = dat;
	    switch (key_trans_send[0]) {
		/*
		 * コード系切り替え
		 */
	    case 0:
		if (key_trans_sendc >= 2) {
		    key_set_format();
		    /*
		     * Make状態であれば再度Makeコード再発行
		     */
		    if (!(key_scan & 0x80) && key_scan) {
			keyboard_make(key_scan);
		    }
		}
		break;
		/*
		 * コード系読み取り
		 */
	    case 1:
		key_get_format();
		break;
		/*
		 * LED設定
		 */
	    case 2:
		if (key_trans_sendc >= 2) {
		    key_set_led();

		    if (key_format != KEY_FORMAT_SCAN) {
			/*
			 * Make状態であれば再度Makeコード発行
			 */
			if (!(key_scan & 0x80) && key_scan) {
			    keyboard_make(key_scan);
			}
		    }
		}
		break;
		/*
		 * LED取得
		 */
	    case 3:
		key_get_led();
		break;
		/*
		 * リピート設定
		 */
	    case 4:
		if (key_trans_sendc >= 2) {
		    key_set_repeat();
		}
		break;
		/*
		 * リピート時間設定
		 */
	    case 5:
		if (key_trans_sendc >= 3) {
		    key_set_time();
		}
		break;
		/*
		 * RTC送受信
		 */
	    case 0x80:
		if (key_trans_sendc >= 2) {
		    if (key_trans_send[1] == 0) {
			key_get_rtc();
			break;
		    }
		    if (key_trans_send[1] == 1) {
			if (key_trans_sendc >= 9) {
			    key_set_rtc();
			}
			break;
		    }
		    /*
		     * 未定義パラメータ
		     */
		    key_trans_sendc = 0;
		}
		break;
		/*
		 * 画面ディジタイズ
		 */
	    case 0x81:
		if (key_trans_sendc >= 2) {
		    key_capture();
		}
		break;
		/*
		 * 画面モード制御
		 */
	    case 0x82:
		if (key_trans_sendc >= 2) {
		    key_set_scrmode();
		}
		break;
		/*
		 * 画面モード取得
		 */
	    case 0x83:
		key_get_scrmode();
		break;
		/*
		 * テレビ画面輝度制御
		 */
	    case 0x84:
		if (key_trans_sendc >= 2) {
		    key_set_scrtone();
		}
		break;
		/*
		 * それ以外はNOP
		 */
	    default:
		key_trans_sendc = 0;
	    }

	    /*
	     * 5μs経過後(適当)にACK送信
	     */
	    key_trans_ack = FALSE;
	    schedule_setevent(EVENT_KEYENC_ACK, 5, key_send_ack);
	}
	return TRUE;
#endif
    }

    return FALSE;
}

/*-[ キーコード変換 ]-------------------------------------------------------*/

/*
 *      キーボード
 *      シフト状態フラグ更新
 */
static BOOL     FASTCALL
keyboard_update_shift(BYTE dat)
{
    switch (dat) {
	/*
	 * 左SHIFT 押した
	 */
    case 0x53:
	shift_flag = TRUE;
	lshift_flag = TRUE;
	return TRUE;

	/*
	 * 左SHIFT 離した
	 */
    case 0x53 + 0x80:
	lshift_flag = FALSE;
	if (!rshift_flag) {
	    shift_flag = FALSE;
	}
	return TRUE;

	/*
	 * 右SHIFT 押した
	 */
    case 0x54:
	shift_flag = TRUE;
	rshift_flag = TRUE;
	return TRUE;

	/*
	 * 右SHIFT 離した
	 */
    case 0x54 + 0x80:
	rshift_flag = FALSE;
	if (!lshift_flag) {
	    shift_flag = FALSE;
	}
	return TRUE;

	/*
	 * CTRL 押した
	 */
    case 0x52:
	ctrl_flag = TRUE;
	return TRUE;

	/*
	 * CTRL 離した
	 */
    case 0x52 + 0x80:
	ctrl_flag = FALSE;
	return TRUE;

	/*
	 * GRAPH 押した
	 */
    case 0x56:
	graph_flag = TRUE;
	return TRUE;

	/*
	 * GRAPH 離した
	 */
    case 0x56 + 0x80:
	graph_flag = FALSE;
	return TRUE;

	/*
	 * CAP 押した
	 */
    case 0x55:
	if (key_format != KEY_FORMAT_SCAN) {
	    caps_flag = !(caps_flag);
	}
	return TRUE;

	/*
	 * カナ 押した
	 */
    case 0x5a:
	if (key_format != KEY_FORMAT_SCAN) {
	    kana_flag = !(kana_flag);
	}
	return TRUE;

	/*
	 * BREAK 押した
	 */
    case 0x5c:
	break_flag = TRUE;
	maincpu_firq();
	return TRUE;

	/*
	 * BREAK 離した
	 */
    case 0x5c + 0x80:
	break_flag = FALSE;
	maincpu_firq();
	return TRUE;
    }

    return FALSE;
}

/*
 *      キーボード
 *      Make/Breakコード→FM-7コード変換
 */
WORD            FASTCALL
keyboard_to_fm7(BYTE dat)
{
    int             i;

    /*
     * シフト状態フラグを更新
     */
    if (keyboard_update_shift(dat)) {
	return 0xffff;
    }

    /*
     * Makeコード化
     */
    dat &= 0x7f;

    /*
     * CTRLモード
     */
    if (ctrl_flag) {
	for (i = 0; i < (sizeof(ctrl_key_table) / 3); i++) {
	    if (dat == ctrl_key_table[i * 3]) {
		if (!shift_flag) {
		    return ctrl_key_table[i * 3 + 1];
		} else {
		    return ctrl_key_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * GRAPHモード
     */
    if (graph_flag) {
	for (i = 0; i < (sizeof(graph_key_table) / 3); i++) {
	    if (dat == graph_key_table[i * 3]) {
		if (!shift_flag) {
		    return graph_key_table[i * 3 + 1];
		} else {
		    return graph_key_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * かなモード
     */
    if (kana_flag) {
	for (i = 0; i < (sizeof(kana_key_table) / 3); i++) {
	    if (dat == kana_key_table[i * 3]) {
		if (!shift_flag) {
		    return kana_key_table[i * 3 + 1];
		} else {
		    return kana_key_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * CAPモード
     */
    if (caps_flag) {
	for (i = 0; i < (sizeof(caps_key_table) / 3); i++) {
	    if (dat == caps_key_table[i * 3]) {
		if (!shift_flag) {
		    return caps_key_table[i * 3 + 1];
		} else {
		    return caps_key_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * ノーマルモード
     */
    for (i = 0; i < (sizeof(norm_key_table) / 3); i++) {
	if (dat == norm_key_table[i * 3]) {
	    if (!shift_flag) {
		return norm_key_table[i * 3 + 1];
	    } else {
		return norm_key_table[i * 3 + 2];
	    }
	}
    }

    return 0xffff;
}

/*
 *      キーボード
 *      Make/Breakコード→FM-16βコード変換
 */
#if XM7_VER >= 2
WORD            FASTCALL
keyboard_to_fm16b(BYTE dat)
{
    int             i;

    /*
     * シフト状態フラグを更新
     */
    if (keyboard_update_shift(dat)) {
	return 0xffff;
    }

    /*
     * Makeコード化
     */
    dat &= 0x7f;

    /*
     * CTRLモード
     */
    if (ctrl_flag) {
	for (i = 0; i < (sizeof(ctrl_16b_table) / 3); i++) {
	    if (dat == ctrl_16b_table[i * 3]) {
		if (!shift_flag) {
		    return ctrl_16b_table[i * 3 + 1];
		} else {
		    return ctrl_16b_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * GRAPHモード
     */
    if (graph_flag) {
	for (i = 0; i < (sizeof(graph_16b_table) / 3); i++) {
	    if (dat == graph_16b_table[i * 3]) {
		if (!shift_flag) {
		    return graph_16b_table[i * 3 + 1];
		} else {
		    return graph_16b_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * かなモード
     */
    if (kana_flag) {
	for (i = 0; i < (sizeof(kana_16b_table) / 3); i++) {
	    if (dat == kana_16b_table[i * 3]) {
		if (!shift_flag) {
		    return kana_16b_table[i * 3 + 1];
		} else {
		    return kana_16b_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * CAPモード
     */
    if (caps_flag) {
	for (i = 0; i < (sizeof(caps_16b_table) / 3); i++) {
	    if (dat == caps_16b_table[i * 3]) {
		if (!shift_flag) {
		    return caps_16b_table[i * 3 + 1];
		} else {
		    return caps_16b_table[i * 3 + 2];
		}
	    }
	}
	return 0xffff;
    }

    /*
     * ノーマルモード
     */
    for (i = 0; i < (sizeof(norm_16b_table) / 3); i++) {
	if (dat == norm_16b_table[i * 3]) {
	    if (!shift_flag) {
		return norm_16b_table[i * 3 + 1];
	    } else {
		return norm_16b_table[i * 3 + 2];
	    }
	}
    }

    return 0xffff;
}
#endif

/*
 *      キーボード
 *      Make/Breakコード→スキャンコード変換
 */
WORD            FASTCALL
keyboard_to_scan(BYTE dat)
{
    /*
     * シフト状態フラグを更新
     */
    keyboard_update_shift(dat);

    /*
     * コードを代入
     */
    return (WORD) dat;
}

/*-[ リピート、Make、Break ]------------------------------------------------*/

/*
 *      キーボード
 *      リピートタイマイベント
 */
static BOOL     FASTCALL
keyboard_event(void)
{
    if (key_repeat_flag) {
	/*
	 * Makeコードを再ロードする(スキャンモード時)
	 */
	if (key_format == KEY_FORMAT_SCAN) {
	    key_fm7 = key_repeat_code;
	}

	/*
	 * CPUへ割り込み
	 */
	key_irq_flag = TRUE;
	maincpu_irq();
	subcpu_firq();

	/*
	 * 次のイベント
	 */
	schedule_setevent(EVENT_KEYBOARD, key_repeat_time2,
			  keyboard_event);
	return TRUE;
    }

    return FALSE;
}

/*
 *      キーボード
 *      キーリピートタイマ変更
 */
void            FASTCALL
keyboard_repeat(void)
{
    schedule_setevent(EVENT_KEYBOARD, key_repeat_time2, keyboard_event);
}

/*
 *      キーボード
 *      Make
 */
void            FASTCALL
keyboard_make(BYTE dat)
{
    WORD            code;

#if XM7_VER >= 2
    /*
     * ディジタイズキー待ちの場合は、ディジタイズを止めキーを読み捨てる
     */
    if (digitize_keywait) {
	/*
	 * 画面モード復帰
	 */
	simpose_mode = simpose_mode_bak;

	/*
	 * ディジタイズ実行
	 */
	if (digitize_enable) {
	    digitize_notify();
	}

	digitize_keywait = FALSE;
	return;
    }
#else
    /*
     * 無変換/変換を強制的にSPACEに割り当て
     */
    if ((dat == 0x57) || (dat == 0x58)) {
	dat = 0x35;
    }
#endif

    /*
     * コード記憶
     */
    key_scan = dat;

    /*
     * データ変換
     */
#if XM7_VER >= 2
    switch (key_format) {
	/*
	 * FM-7互換モード
	 */
    case KEY_FORMAT_9BIT:
	code = keyboard_to_fm7(dat);
	break;
	/*
	 * FM-16βモード
	 */
    case KEY_FORMAT_FM16B:
	code = keyboard_to_fm16b(dat);
	break;
	/*
	 * スキャンモード
	 */
    case KEY_FORMAT_SCAN:
	code = keyboard_to_scan(dat);
	break;
	/*
	 * それ以外
	 */
    default:
	ASSERT(FALSE);
	break;
    }
#else
    code = keyboard_to_fm7(dat);
#endif

    /*
     * シフトキーチェック
     */
    if (shift_flag) {
	/*
	 * キーリピートon/off
	 */
	if (ctrl_flag) {
	    /*
	     * SHIFT+CTRL+0 キーリピートoff
	     */
	    if ((dat == 0x0b) || (dat == 0x46)) {
		key_repeat_flag = FALSE;
		return;
	    }
	    /*
	     * SHIFT+CTRL+1 キーリピートon
	     */
	    if ((dat == 0x02) || (dat == 0x42)) {
		key_repeat_flag = TRUE;
		return;
	    }
	}
#if XM7_VER >= 2
	/*
	 * スーパーインポーズ
	 */
	switch (dat) {
	    /*
	     * SHIFT+PF7 パソコンモード
	     */
	case 0x63:
	    simpose_mode = 0;
	    break;
	    /*
	     * SHIFT+PF8 スーパーインポーズ(高輝度)モード
	     */
	case 0x64:
	    simpose_mode = 1;
	    simpose_half = FALSE;
	    break;
	    /*
	     * SHIFT+PF9 スーパーインポーズ(低輝度)モード
	     */
	case 0x65:
	    simpose_mode = 1;
	    simpose_half = TRUE;
	    break;
	    /*
	     * SHIFT+PF10 TVモード
	     */
	case 0x66:
	    simpose_mode = 2;
	    break;
	}
#endif
    }

    /*
     * コードが有効なら、記憶して割り込み
     */
    if (code != 0xffff) {
	key_fm7 = code;

	/*
	 * 割り込み
	 */
	key_irq_flag = TRUE;
	maincpu_irq();
	subcpu_firq();

	if ((code >= 0x101) && (code <= 0x10a)) {
	    /*
	     * PFキーは、リピートなし
	     */
	    schedule_delevent(EVENT_KEYBOARD);
	} else {
	    /*
	     * PFキー以外なら、リピートあり
	     */
	    key_repeat_code = dat;
	    schedule_setevent(EVENT_KEYBOARD, key_repeat_time1,
			      keyboard_event);
	}
    } else {
	/*
	 * イベント削除
	 */
	schedule_delevent(EVENT_KEYBOARD);
    }
}

/*
 *      キーボード
 *      Break
 */
void            FASTCALL
keyboard_break(BYTE dat)
{
#if XM7_VER == 1
    /*
     * 無変換/変換を強制的にSPACEに割り当て
     */
    if ((dat == 0x57) || (dat == 0x58)) {
	dat = 0x35;
    }
#endif

    /*
     * ワークに記憶
     */
    key_scan = (BYTE) (dat | 0x80);

    /*
     * データ変換
     */
#if XM7_VER >= 2
    switch (key_format) {
	/*
	 * FM-7互換モード
	 */
    case KEY_FORMAT_9BIT:
	keyboard_to_fm7(key_scan);
	break;
	/*
	 * FM-16βモード
	 */
    case KEY_FORMAT_FM16B:
	keyboard_to_fm16b(key_scan);
	break;
	/*
	 * スキャンモード
	 */
    case KEY_FORMAT_SCAN:
	keyboard_to_scan(key_scan);
	break;
	/*
	 * それ以外
	 */
    default:
	ASSERT(FALSE);
	break;
    }
#else
    keyboard_to_fm7(key_scan);
#endif

    /*
     * スキャンモードの場合は、Breakデータを入力
     */
    if (key_format == KEY_FORMAT_SCAN) {
	key_fm7 = key_scan;

	/*
	 * 割り込み
	 */
	key_irq_flag = TRUE;
	maincpu_irq();
	subcpu_firq();
    }

    /*
     * リピートなし
     */
    if (dat == key_repeat_code) {
	schedule_delevent(EVENT_KEYBOARD);
    }
}

/*
 *      キーボード
 *      セーブ
 */
BOOL            FASTCALL
keyboard_save(SDL_RWops *fileh)
{
    if (!file_bool_write(fileh, caps_flag)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, kana_flag)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, ins_flag)) {
	return FALSE;
    }

    if (!file_bool_write(fileh, shift_flag)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, ctrl_flag)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, graph_flag)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, break_flag)) {
	return FALSE;
    }

    if (!file_byte_write(fileh, key_scan)) {
	return FALSE;
    }
    if (!file_word_write(fileh, key_fm7)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, key_repeat_flag)) {
	return FALSE;
    }

    if (!file_byte_write(fileh, key_format)) {
	return FALSE;
    }
    if (!file_dword_write(fileh, key_repeat_time1)) {
	return FALSE;
    }
    if (!file_dword_write(fileh, key_repeat_time2)) {
	return FALSE;
    }
    if (!file_byte_write(fileh, key_repeat_code)) {
	return FALSE;
    }
#if XM7_VER >= 2
    if (!file_write(fileh, key_trans_send, sizeof(key_trans_send))) {
	return FALSE;
    }
    if (!file_byte_write(fileh, key_trans_sendc)) {
	return FALSE;
    }
    if (!file_write(fileh, key_trans_recv, sizeof(key_trans_recv))) {
	return FALSE;
    }
    if (!file_byte_write(fileh, key_trans_recvc)) {
	return FALSE;
    }
    if (!file_byte_write(fileh, key_trans_pos)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, key_trans_rxrdy)) {
	return FALSE;
    }

    /*
     * スーパーインポーズ、ディジタイズ(ファイルバージョン5で拡張)
     */
    if (!file_byte_write(fileh, simpose_mode)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, simpose_half)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, digitize_enable)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, digitize_keywait)) {
	return FALSE;
    }
#endif

    /*
     * 左右シフトフラグ(Ver9.03/7.03で拡張)
     */
    if (!file_bool_write(fileh, lshift_flag)) {
	return FALSE;
    }
    if (!file_bool_write(fileh, rshift_flag)) {
	return FALSE;
    }
#if XM7_VER >= 2
    /*
     * キーボードエンコーダACK(Ver9.06/7.06で拡張)
     */
    if (!file_bool_write(fileh, key_trans_ack)) {
	return FALSE;
    }
#endif

    return TRUE;
}

/*
 *      キーボード
 *      ロード
 */
BOOL            FASTCALL
keyboard_load(SDL_RWops *fileh, int ver)
{
    /*
     * バージョンチェック
     */
    if (ver < 200) {
	return FALSE;
    }

    if (!file_bool_read(fileh, &caps_flag)) {
	return FALSE;
    }
    if (!file_bool_read(fileh, &kana_flag)) {
	return FALSE;
    }
    if (!file_bool_read(fileh, &ins_flag)) {
	return FALSE;
    }

    if (!file_bool_read(fileh, &shift_flag)) {
	return FALSE;
    }
    if (!file_bool_read(fileh, &ctrl_flag)) {
	return FALSE;
    }
    if (!file_bool_read(fileh, &graph_flag)) {
	return FALSE;
    }
    if (!file_bool_read(fileh, &break_flag)) {
	return FALSE;
    }

    if (!file_byte_read(fileh, &key_scan)) {
	return FALSE;
    }
    if (!file_word_read(fileh, &key_fm7)) {
	return FALSE;
    }
    if (!file_bool_read(fileh, &key_repeat_flag)) {
	return FALSE;
    }

    if (!file_byte_read(fileh, &key_format)) {
	return FALSE;
    }
    if (!file_dword_read(fileh, &key_repeat_time1)) {
	return FALSE;
    }
    if (!file_dword_read(fileh, &key_repeat_time2)) {
	return FALSE;
    }
    if (!file_byte_read(fileh, &key_repeat_code)) {
	return FALSE;
    }
#if XM7_VER >= 2
    if (!file_read(fileh, key_trans_send, sizeof(key_trans_send))) {
	return FALSE;
    }
    if (!file_byte_read(fileh, &key_trans_sendc)) {
	return FALSE;
    }
    if (!file_read(fileh, key_trans_recv, sizeof(key_trans_recv))) {
	return FALSE;
    }
    if (!file_byte_read(fileh, &key_trans_recvc)) {
	return FALSE;
    }
    if (!file_byte_read(fileh, &key_trans_pos)) {
	return FALSE;
    }
    if (!file_bool_read(fileh, &key_trans_rxrdy)) {
	return FALSE;
    }

    /*
     * スーパーインポーズ、ディジタイズ(ファイルバージョン5で拡張)
     */
    if (ver >= 500) {
	if (!file_byte_read(fileh, &simpose_mode)) {
	    return FALSE;
	}
	if (!file_bool_read(fileh, &simpose_half)) {
	    return FALSE;
	}
	if (!file_bool_read(fileh, &digitize_enable)) {
	    return FALSE;
	}
	if (!file_bool_read(fileh, &digitize_keywait)) {
	    return FALSE;
	}
    }
#endif

    /*
     * 左右シフトフラグ(Ver9.03/7.03で拡張)
     */
#if XM7_VER >= 3
    if ((ver >= 903) || ((ver >= 703) && (ver <= 799))) {
#elif XM7_VER >= 2
    if (ver >= 703) {
#else
    if (ver >= 300) {
#endif
	if (!file_bool_read(fileh, &lshift_flag)) {
	    return FALSE;
	}
	if (!file_bool_read(fileh, &rshift_flag)) {
	    return FALSE;
	}
    } else {
	/*
	 * 実際の状態と矛盾が生じるが…
	 */
	lshift_flag = FALSE;
	rshift_flag = FALSE;
    }

#if XM7_VER >= 2
    /*
     * キーボードエンコーダACK(Ver9.06/7.06で拡張)
     */
#if XM7_VER >= 3
    if ((ver >= 906) || ((ver >= 706) && (ver <= 799))) {
#else
    if ((ver >= 706) && (ver <= 799)) {
#endif
	if (!file_bool_read(fileh, &key_trans_ack)) {
	    return FALSE;
	}
    } else {
	key_trans_ack = TRUE;
    }
#endif

    /*
     * イベント
     */
    schedule_delevent(EVENT_KEYBOARD);
#if XM7_VER >= 2
    schedule_handle(EVENT_KEYENC_ACK, key_send_ack);
#endif

    return TRUE;
}
